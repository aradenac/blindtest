doctype html
html(lang="fr")
  head
    meta(charset='utf-8')
    meta(name='viewport' content='width=device-width, initia-scale=1.0')
    title Admin | WhatSong
    link(rel='icon' type='image/png' href='/favicon.ico')
    link(rel='apple-touch-icon' href='/favicon.ico')
    link(rel='stylesheet' type='text/css' href='/stylesheets/style.css')
    script(src='https://code.jquery.com/jquery-3.5.0.min.js' integrity='sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=' crossorigin='anonymous')
    script(src=" https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.3/jsmediatags.min.js")
  body
    #outputDiv

    p#uploadMsg #{uploadMsg}
    form(id="songUploadForm" action="/submit/song" method="post" enctype="multipart/form-data")
      h2 Ajouter une chanson dans la base de données
      br
      input(id="songInput" type="file" name="song" value="Choose a file" autofocus)
      input(id="submitButton" type="submit" name="submit" value="Upload" disabled)
    div(class="row")
      div(class="column1")
        h2 Playlists en base de données:
          table
            thead
              tr
                th Nom de la playlist
                th Supprimer
                th Modifier
            tbody
              tr
                td Playlist 1
                td 
                  input(type="submit" value="Supprimer")
                td 
                  input(type="submit" value="Modifer") 
        
      div(class="column2")    
        h2 Créer/Modifier une playlist:
        
        form(action="")
          label Nom de la playlist:
          br
          input(class="typing-input" type="text")
          table
            thead
              tr
                th Artiste
                th Titre
                th Supprimer
            tbody
              tr
                td Artiste 1
                td Titre 1
                td 
                  input(type="submit" value="Supprimer")
          input(class="input-left" type="submit" value="Valider la playlist")
    h2 Chansons en base de données:
    br
    label Recherche par mots-clés:
    br
    input(class="typing-input" type="text" name="searchByKW")
    table
      thead
        tr
          th Artiste
          th Titre
          th Supprimer
          th Ajouter à une playlist
      tbody
        tr
          td Artiste 1
          td Titre 1
          td 
            input(type="submit" value="Supprimer")
          td
            form(action="")
              select(name="playlists" id="playlists")
                optgroup
                  option(value="playlistID") Playlist 1
              input(type="submit" value="Valider")   


    script.
      var file = document.getElementById('songInput');
      $('#songUploadForm :submit').prop('disabled', true)
      $('#songInput').val('')

      $('#submitButton').click(()=>{
        $('#uploadMsg').text('Submitting ...')
        $('#songUploadForm :submit').prop('disabled', true)
      })

      file.addEventListener("change", function(e){
        enableForm(true);

        $('#uploadMsg').text('Submitting ...')
        var f = event.target.files[0];
        jsmediatags.read(f, {
          onSuccess: function(tag) {
            enableForm(true)
            if (!('artist' in tag.tags) || !('title' in tag.tags)){
              $('#uploadMsg').text('Mising title/artist in mp3 metadata')
              $('#songInput').val('')
              $('#songUploadForm :submit').prop('disabled', true)
            }
            else{
              $('#uploadMsg').text('Ready for upload');
              $('#songUploadForm :submit').prop('disabled', false)
            }
          },
          onError: function(error) {
            enableForm(true)
            $('#uploadMsg').text('Invalid file')
            $('#songInput').val('')
            $('#songUploadForm :submit').prop('disabled', true)
          }
         })
        }, false)

      function enableForm(b){
        var songInput = $('#songInput')
        var submitButton = $('#submitButton')

        var arr = [songInput, submitButton]

        for (e of arr) {
          if (!b)
            e.prop('disabled', true);
          else
            e.prop('disabled', false);
        }
       }
